import React, { createContext, useContext, useState } from "react";
import { BrowserRouter as Router, Routes, Route, NavLink, useParams } from "react-router-dom";
import { motion } from "framer-motion";
import { Film, Tv, Users2, Rocket, Newspaper, BookOpen, Play, X } from "lucide-react";

// ===================== THEME =====================
const theme = {
  bg: "#06070a",
  text: "#e7f7ff",
  neonPink: "#ff2d6f",
  neonCyan: "#17e0ff",
};

// ===================== DATA =====================
// NOTE: to enable a real trailer later, set trailer to a URL
// Example YouTube: "https://www.youtube.com/embed/XXXXXXXX"
// Example MP4: "/trailers/forbidden-allure.mp4"
const films = [
  {
    id: "forbidden-allure",
    title: "Forbidden Allure",
    year: 2026,
    rating: "PG-13",
    tagline: "How far will you go to resist the one you crave?",
    poster: "/Forbidden Allure film original.png",
    backdrop: "/Forbidden Allure film original.png",
    description: "A romantic psychological thriller where passion collides with fear. Takeshi, a strict literature teacher, finds himself entangled with Tora in a forbidden relationship that tests both love and sanity.",
    release: "Coming 2026",
    gallery: ["/Forbidden Allure film original.png"],
    trailer: null,
  },
  {
    id: "cybernetic-embrace",
    title: "Cybernetic Embrace",
    year: 2027,
    rating: "PG-13",
    tagline: "She was built to love — and to never let go.",
    poster: "https://images.unsplash.com/photo-1542751110-97427bbecf20?q=80&w=800&auto=format&fit=crop",
    backdrop: "https://images.unsplash.com/photo-1488218650595-b4bc3b7203f5?q=80&w=1600&auto=format&fit=crop",
    description: "Tora awakens as a cyborg. What was once love becomes obsession — and escape may no longer be possible.",
    release: "Planned 2027",
    gallery: ["https://images.unsplash.com/photo-1542751110-97427bbecf20?q=80&w=800&auto=format&fit=crop"],
    trailer: null,
  },
  {
    id: "rusted-love-2099",
    title: "Rusted Love 2099",
    year: 2028,
    rating: "PG-13",
    tagline: "In a broken world, two souls reboot.",
    poster: "https://images.unsplash.com/photo-1519677100203-a0e668c92439?q=80&w=800&auto=format&fit=crop",
    backdrop: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1600&auto=format&fit=crop",
    description: "In a post-apocalyptic wasteland, paralyzed survivor Tom repairs a ruined cyborg — only to discover she is Tora. Together they fight for love in a world of rust and shadows.",
    release: "Planned 2028",
    gallery: ["https://images.unsplash.com/photo-1519677100203-a0e668c92439?q=80&w=800&auto=format&fit=crop"],
    trailer: null,
  },
];

// ===================== TRAILER MODAL (GLOBAL) =====================
const TrailerCtx = createContext({ open: (_f) => {}, close: () => {} });
function useTrailer() { return useContext(TrailerCtx); }

function TrailerProvider({ children }) {
  const [current, setCurrent] = useState(null); // { title, url, poster }
  const open = (film) => {
    if (!film?.trailer) return; // ignore if no trailer yet
    setCurrent({ title: film.title, url: film.trailer, poster: film.backdrop || film.poster });
  };
  const close = () => setCurrent(null);
  return (
    <TrailerCtx.Provider value={{ open, close }}>
      {children}
      <TrailerModal current={current} onClose={close} />
    </TrailerCtx.Provider>
  );
}

function TrailerModal({ current, onClose }) {
  if (!current) return null;
  const { url, title, poster } = current;
  const isMp4 = url.endsWith(".mp4");
  return (
    <div className="fixed inset-0 z-[100] bg-black/80 grid place-items-center p-4" onClick={onClose}>
      <div className="relative w-full max-w-4xl rounded-2xl overflow-hidden border border-white/10 bg-black" onClick={(e) => e.stopPropagation()}>
        <button onClick={onClose} className="absolute right-3 top-3 z-10 inline-flex items-center gap-2 rounded-full border border-white/20 px-3 py-1 text-sm text-white/90 hover:bg-white/10">
          <X size={16}/> Close
        </button>
        {isMp4 ? (
          <video controls className="w-full" poster={poster}>
            <source src={url} type="video/mp4" />
          </video>
        ) : (
          <div className="aspect-video">
            <iframe
              src={url}
              title={`${title} — Trailer`}
              className="w-full h-full"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowFullScreen
            />
          </div>
        )}
        <div className="px-4 py-3 text-white text-sm border-t border-white/10">{title} — Trailer</div>
      </div>
    </div>
  );
}

// ===================== COMPONENTS =====================
function Logo() {
  return (
    <div className="flex items-center gap-3 select-none">
      <img src="/TEMPTORIA Universe Studio Film.png" alt="Temptoria Logo" className="h-10 md:h-12" />
    </div>
  );
}

function Nav() {
  const navCls = ({ isActive }) =>
    `px-3 py-2 text-sm uppercase tracking-wider ${isActive ? "text-white" : "text-slate-300"} hover:text-white`;
  return (
    <div className="sticky top-0 z-50 backdrop-blur bg-black/60">
      <nav className="mx-auto flex max-w-7xl items-center justify-between px-4 py-3">
        <NavLink to="/" className="flex items-center gap-3">
          <Logo />
        </NavLink>
        <div className="hidden md:flex items-center gap-1">
          <NavLink to="/films" className={navCls}><Film size={16}/>Films</NavLink>
          <NavLink to="/series" className={navCls}><Tv size={16}/>Series</NavLink>
          <NavLink to="/characters" className={navCls}><Users2 size={16}/>Characters</NavLink>
          <NavLink to="/universe" className={navCls}><Rocket size={16}/>Universe</NavLink>
          <NavLink to="/news" className={navCls}><Newspaper size={16}/>News</NavLink>
          <NavLink to="/studio" className={navCls}><BookOpen size={16}/>Studio</NavLink>
        </div>
      </nav>
      <div className="h-px w-full" style={{
        background: `linear-gradient(90deg, transparent, ${theme.neonPink}, ${theme.neonCyan}, transparent)`
      }} />
    </div>
  );
}

function FilmCard({ f }) {
  const trailer = useTrailer();
  const hasTrailer = Boolean(f.trailer);
  return (
    <div className="rounded-2xl overflow-hidden border border-white/10 bg-black/40">
      <div className="aspect-[2/3] bg-cover bg-center" style={{ backgroundImage: `url(${f.poster})` }} />
      <div className="p-3">
        <div className="flex items-start justify-between gap-3">
          <div>
            <h3 className="text-lg text-white font-semibold">{f.title}</h3>
            <p className="text-sm text-slate-400">{f.year} • {f.rating}</p>
          </div>
          {hasTrailer && (
            <button onClick={() => trailer.open(f)} className="inline-flex items-center gap-2 rounded-full border border-white/20 px-3 py-1 text-xs hover:bg-white/10">
              <Play size={14}/> Watch Trailer
            </button>
          )}
        </div>
        <p className="text-sm text-slate-300 mt-2">{f.tagline}</p>
      </div>
    </div>
  );
}

function Home() {
  const hero = films[0];
  const trailer = useTrailer();
  return (
    <div className="relative" style={{ background: theme.bg }}>
      <div className="mx-auto max-w-7xl px-4 pt-10 pb-16 grid md:grid-cols-2 items-center gap-10">
        <div>
          <h1 className="text-5xl font-extrabold" style={{ color: theme.text }}>{hero.title}</h1>
          <p className="mt-4 text-slate-300 max-w-xl">{hero.tagline}</p>
          <div className="mt-6 flex gap-3 flex-wrap">
            <NavLink to={`/films/${hero.id}`} className="rounded-full px-5 py-2 inline-flex items-center gap-2 font-medium" style={{ background: theme.neonPink, color: "#081015", boxShadow: `0 8px 30px ${theme.neonPink}55` }}>Explore</NavLink>
            {hero.trailer && (
              <button onClick={() => trailer.open(hero)} className="rounded-full px-5 py-2 inline-flex items-center gap-2 font-medium border border-white/20 hover:bg-white/10">
                <Play size={18}/> Watch Trailer
              </button>
            )}
          </div>
        </div>
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="rounded-2xl overflow-hidden border border-white/10">
          <div className="aspect-video bg-cover bg-center" style={{ backgroundImage: `url(${hero.backdrop})` }} />
        </motion.div>
      </div>

      <div className="mx-auto max-w-7xl px-4 mt-10">
        <h2 className="text-2xl font-bold mb-4" style={{ color: theme.text }}>Films</h2>
        <div className="grid sm:grid-cols-2 md:grid-cols-3 gap-6">
          {films.map(f => (
            <NavLink key={f.id} to={`/films/${f.id}`} className="block hover:scale-[1.01] transition">
              <FilmCard f={f} />
            </NavLink>
          ))}
        </div>
      </div>
    </div>
  );
}

function TrailerBlock({ url, poster }) {
  if (url) {
    const isMp4 = url.endsWith(".mp4");
    return (
      <div className="rounded-2xl overflow-hidden border border-white/10 bg-black/40">
        {isMp4 ? (
          <video controls className="w-full" poster={poster}>
            <source src={url} type="video/mp4" />
          </video>
        ) : (
          <div className="aspect-video">
            <iframe
              src={url}
              title="Trailer"
              className="w-full h-full"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowFullScreen
            />
          </div>
        )}
      </div>
    );
  }
  return (
    <div className="rounded-2xl overflow-hidden border border-white/10 bg-[linear-gradient(135deg,rgba(255,45,111,0.15),rgba(23,224,255,0.12))] grid place-items-center aspect-video">
      <div className="text-center p-6">
        <div className="mx-auto mb-3 grid place-items-center h-12 w-12 rounded-full border border-white/20">
          <Play />
        </div>
        <p className="text-white font-semibold">Trailer coming soon</p>
        <p className="text-slate-300 text-sm mt-1">Add a YouTube/Vimeo embed or MP4 when ready.</p>
      </div>
    </div>
  );
}

function FilmDetail() {
  const { id } = useParams();
  const trailer = useTrailer();
  const film = films.find(f => f.id === id);
  if (!film) return <div className="p-10 text-center text-slate-400">Film not found.</div>;
  return (
    <div className="mx-auto max-w-6xl px-4 py-10">
      <div className="grid md:grid-cols-2 gap-8 items-start">
        <div>
          <img src={film.poster} alt={film.title} className="rounded-2xl border border-white/10" />
        </div>
        <div>
          <h1 className="text-4xl font-bold text-white">{film.title}</h1>
          <p className="mt-2 text-slate-400">{film.year} • {film.rating}</p>
          <p className="mt-4 text-slate-300">{film.description}</p>
          <p className="mt-4 text-sm" style={{ color: theme.neonCyan }}>{film.release}</p>
          {film.trailer && (
            <button onClick={() => trailer.open(film)} className="mt-5 inline-flex items-center gap-2 rounded-full border border-white/20 px-4 py-2 hover:bg-white/10">
              <Play size={16}/> Watch Trailer
            </button>
          )}
        </div>
      </div>

      {/* Trailer Section */}
      <div className="mt-10">
        <h2 className="text-2xl font-semibold mb-4 text-white">Trailer</h2>
        <TrailerBlock url={film.trailer} poster={film.backdrop || film.poster} />
      </div>

      {/* Gallery */}
      <div className="mt-10">
        <h2 className="text-2xl font-semibold mb-4 text-white">Gallery</h2>
        <div className="grid sm:grid-cols-2 md:grid-cols-3 gap-4">
          {film.gallery.map((g, i) => (
            <img key={i} src={g} alt="still" className="rounded-xl border border-white/10" />
          ))}
        </div>
      </div>
    </div>
  );
}

function Footer() {
  return (
    <footer className="mt-20 border-t border-white/10">
      <div className="mx-auto max-w-7xl px-4 py-10 grid md:grid-cols-3 gap-8">
        <div>
          <Logo />
          <p className="mt-3 text-sm text-slate-400 max-w-sm">
            Temptoria Universe — original anime film studio. Neon romance, psychological thrillers, and cyberpunk stories.
          </p>
        </div>
      </div>
    </footer>
  );
}

// ===================== APP =====================
function AppShell() {
  return (
    <TrailerProvider>
      <div style={{ background: theme.bg, color: theme.text, minHeight: "100vh" }}>
        <Nav />
        <main>
          <Routes>
            <Route path="/" element={<Home />} />
            <Route path="/films/:id" element={<FilmDetail />} />
          </Routes>
        </main>
        <Footer />
      </div>
    </TrailerProvider>
  );
}

export default function App() {
  return (
    <Router>
      <AppShell />
    </Router>
  );
}
